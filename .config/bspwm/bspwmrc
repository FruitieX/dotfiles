#!/usr/bin/zsh
#unset DBUS_SESSION_BUS_ADDRESS
#
export BSPWM_TREE=/tmp/bspwm.tree
export BSPWM_HISTORY=/tmp/bspwm.history
export BSPWM_STACK=/tmp/bspwm.stack
export PANEL_FIFO=/tmp/panel-fifo

killall -9 sxhkd compton
export BSPWM_SOCKET=/tmp/bspwm-socket
sxhkd -c ~/.config/bspwm/sxhkdrc &
compton --config ~/.compton.conf &

i=1
IFS=$'\r\n' DESKTOPS=($(cat ~/.config/bspwm/desktops))

for monitor in $(bspc query -M); do
	bspc monitor "$monitor" -d ${DESKTOPS[$i]}
	#bspc configure "$monitor" top_padding
	i=$((i+1))
done

for desktop in $(seq $i ${#DESKTOPS[@]}); do
	#bspc monitor primary -a $desktop # THIS SEGFAULTS on one monitor!
	bspc monitor focused -a ${DESKTOPS[$desktop]}
done

bspc config split_ratio             0.50
bspc config border_width            3
bspc config window_gap              29
bspc config borderless_monocle      true
bspc config gapless_monocle         true
bspc config auto_cancel				true
bspc config remove_disabled_monitor	true
bspc config normal_border_color     "#181512"
bspc config focused_border_color    "#9a875f"
#bspc config presel_border_color     "#d87d79"
bspc config presel_border_color     "#d6c3b6"
bspc config rule_command			"~/.config/bspwm/rules.sh"

if [[ $HOST == "servy" ]]; then
	bspc config top_padding				0
	unset TMUX
	urxvt -title tmux -e ~/bin/tmx &
	sleep 3
	tmux source-file ~/.tmux.servy
else
	if [ -e "$BSPWM_TREE" ] ; then
		bspc restore -T "$BSPWM_TREE" -H "$BSPWM_HISTORY" -S "$BSPWM_STACK"
		rm "$BSPWM_TREE" "$BSPWM_HISTORY" "$BSPWM_STACK"
	fi
	bspc config top_padding				18
	~/bin/panel &
fi
